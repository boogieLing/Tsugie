# Tsugie iOS 开发交接总纲 v1

更新日期：2026-02-14  
适用范围：从当前 Web/HTML 原型基线迁移到正式 iOS（SwiftUI）开发

---

## 1. 文档目标

- 汇总当前阶段历史需求、语义规范、组件结构、页面结构、交互逻辑、关联逻辑。
- 作为 iOS 开发阶段的统一入口文档，减少“口头规则”和分散文档带来的偏差。
- 明确 MVP 边界，确保“能上线验证价值”优先于功能扩张。

---

## 2. 历史需求演进（总览）

### 2.1 基线阶段（MVP v0.1）

- 产品定位：在当前时间与位置下，给出“下一站值得去的へ”决策。
- 核心原则：打开即用、无需登录、地图优先、决策优先、表达克制。
- 基础链路：地图页 -> quickCard（快速查看） -> 详情页。

### 2.2 Node 0:1 迭代阶段（v1 -> v8）

- v1：地图优先主链路落地（全屏地图、点位、nearby、quickCard）。
- v2/v3：详情页与状态演示可复现化（upcoming/ongoing/ended + 手势阈值 + 实时状态刷新）。
- v4：日历从叠加面板改为“独立页面语义”（时间维度独立于地图维度）。
- v5：进度条跨场景统一（详情页、nearby、日历抽屉、收藏列表同源）。
- v6：时间表达统一与去冗余（quick/nearby/calendar drawer 与详情页同一时间语义）。
- v7：收藏/打卡闭环（地图点位气泡操作 + 左侧收藏抽屉 + 全场景状态 logo）。
- v8：主题调节能力（透明度比例、饱和度）与顶栏定位按钮节奏统一。

### 2.3 当前阶段结论

- 需求已经从“单一花火场景原型”演进为“通用 へ 平台 MVP 基线”。
- 页面和组件语义基本稳定，可进入 iOS 正式实现。

---

## 3. 统一语义与术语（强约束）

### 3.1 业务实体语义

- `へ`：统一业务实体，表示“可前往地点（Place Entity）”。
- `heType`：垂类类型（如 `hanabi`、`matsuri`、`nature`、未来可扩展到 `music/food/onsen/night-view`）。
- UI 展示名必须使用真实地点名，不使用“xxxへ”后缀。

### 3.2 状态语义

- 收藏（favorite）：想要访问。
- 打卡（checkedIn）：已经访问。
- 活动时态：
- `upcoming` 未开始
- `ongoing` 进行中
- `ended` 已结束
- `unknown` 时刻信息不足

### 3.3 页面语义

- 地图主页：位置维度决策。
- 日历页（時めぐり）：时间维度统计。
- quickCard：快速查看（非详情）。
- 详情页：完整信息承载。

---

## 4. 页面清单（当前信息架构）

### 4.1 地图主页（Home / Map）

- 地图全屏展示，默认不弹卡片。
- 地图内可点击点位。
- 底部 nearby 轮播（用于补充“视野外但可去”的候选）。
- 顶部控制：`時めぐり` 入口、定位按钮、top-kaomoji（菜单入口）。

### 4.2 quickCard（底部快速查看）

- 来源：点位点击、nearby 点击、延时自动推荐。
- 关键内容：地点名、时间范围、距离+日期文案、进度条、操作按钮。
- 手势：上划打开详情，下滑/关闭按钮关闭（与关闭语义一致）。

### 4.3 详情页（Detail Panel）

- 全屏上拉面板。
- 内容：地点名、距离、开放时间、状态进度区、活动图、地图 focus、介绍、热度/惊喜度。
- 关闭：下拉手势或关闭按钮。

### 4.4 右侧主侧栏（Side Drawer）

- 入口：top-kaomoji。
- 默认打开后不选中任何菜单项。
- 当前菜单：行きたい栞（收藏入口）、通知设置、联系我。
- 顶部含配色胶囊与主题调节（透明度比例、饱和度）。

### 4.5 左侧收藏抽屉（Favorite Drawer）

- 从右侧主侧栏的“行きたい栞”触发。
- 承载收藏列表本体，不放在右侧内容区内展开。
- 筛选：全部 / 未打卡 / 已打卡。
- 打开时有颗粒化蒙砂遮罩，覆盖其下层级。

### 4.6 日历独立页（Calendar Page）

- 入口：`時めぐり`。
- 结构：传统月历（周日开头，7列日格，按月上下连续堆叠）。
- 日格仅展示分类统计（icon + count），不展示地点名。
- 默认定位到今天，今天高亮跟随当前主题。

### 4.7 日历日抽屉（Calendar Day Drawer）

- 点击有活动的日期弹出。
- 仅服务于日历页，不复用主页侧栏。
- 支持按类别过滤（默认全部）。
- 列表顺序与推荐顺序保持一致。

### 4.8 地图点位操作气泡（Marker Action Bubble）

- 点位点击先弹弧形透明操作浮层（非方卡）。
- 动作：收藏切换、打卡切换、进入 quickCard。

---

## 5. 组件清单与复用关系

### 5.1 核心复用组件

- 统一状态计算：`resolveEventStatus(place)`。
- 统一进度定位：`setProgressPosition(track, fill, face, endpoint, pct)`。
- 统一 mini-progress：nearby、日历日抽屉、收藏列表复用同一进度语义。
- 统一状态 logo：quickCard、详情、nearby、日历抽屉、收藏抽屉同源。

### 5.2 关键组件语义

- `quick-progress`：quickCard 状态进度表达。
- `detail-progress`：详情页状态进度表达。
- `mini-progress`：列表场景轻量状态表达。
- `status-endpoint`：进度端点（`へ` 小胶囊）。
- `place-state-icons`：收藏/打卡 logo 组。

### 5.3 主题与视觉 token

- 基础 token：`--theme-*`。
- 实时渲染 token：`--theme-live-*`（用于透明度比例与饱和度调整后的结果）。
- 规则：新增组件优先接入 `--theme-live-*`，避免主题调节失效。

---

## 6. 交互逻辑（状态机级别）

### 6.1 主链路

1. 首次进入：全屏地图 + 点位 + nearby。
2. 点位点击：先开操作气泡。
3. 选择“进入 quickCard”或直接触发 quick：底部 quickCard 弹出。
4. quickCard 上划：详情页全屏展开。
5. 详情页下拉：回到 quickCard 或主页状态。

### 6.2 面板互斥规则

- quickCard 可见时：nearby 隐藏。
- detail 可见时：quickCard 和 nearby 都隐藏。
- calendar 可见时：进入独立页面，不与主页面板做细粒度互斥。

### 6.3 日历独立页规则

- 打开日历：主页组件整体隐藏（页面切换语义）。
- 关闭日历：恢复主页状态。
- 日历日抽屉仅属于日历页上下文。

### 6.4 侧栏与收藏抽屉规则

- 侧栏默认无激活项。
- 收藏抽屉在右侧侧栏上层。
- 点击收藏抽屉遮罩：只关闭收藏抽屉，不关闭右侧侧栏。
- Esc 关闭优先级：收藏抽屉 -> 日历日抽屉 -> 日历页 -> 侧栏 -> 详情 -> quickCard。

### 6.5 手势阈值（来自 v3 可复现基线）

- quickCard 上划开详情：
- `delta <= -44`，或 `delta <= -20 且耗时 <= 220ms`。
- 详情页下拉关闭：
- pointer 分支 `delta >= 120`。
- touch 分支 `delta >= 110`。

---

## 7. 关联逻辑（必须同源）

### 7.1 时间与倒计时逻辑

- 所有场景统一使用 `resolveEventStatus` 输出时间状态。
- 倒计时粒度：
- `>=1日`：`xx日xx時間`
- `<1日 且 >=1小时`：`xx時間xx分xx秒`
- `<1小时 且 >=5分钟`：`xx分xx秒`
- `<5分钟`：`xx秒`

### 7.2 进度条展示逻辑

- `ongoing`：按活动进度。
- `upcoming`：按等待进度（接近开始时增长）。
- `ended`：100%。
- 特殊规则：`upcoming` 且距开始超过 1 日时，列表 mini-progress 不显示。
- 端点边缘吸附：左 <= 8%，右 >= 92%。

### 7.3 推荐与排序逻辑（MVP）

- 推荐优先：按 `FinalScore` 统一排序（空间 + 时间主导，热度补充，类别权重修正）。
- 系统默认输出一个“最速攻略へ”。
- 日历某日列表排序：保持与推荐顺序一致（距离优先 + 开始优先，热度兜底）。
- 数据字段与算法对齐基线：以 `需求/Tsugie_Recommendation_Algorithm_V1.docx` 与 `需求/Tsugie_Recommendation_Algorithm_V1_数据对齐修订.md` 为准（2026-02-19 回调）。
- 在当前 iOS 数据包覆盖率下，`expected_visitors` 与 `launch_scale` 仅作为补充信息，不作为主排序强依赖。
- 评分公式默认采用 V1（docx 回调）：`FinalScore = (0.45 * SpaceScore + 0.45 * TimeScore + 0.10 * HeatScore) * CategoryWeight`。
- `CategoryWeight` 默认：`hanabi=1.2`、`matsuri=1.0`、`nature=0.8`、`other=1.0`。
- `upcoming` 的 `TimeScore` 在 `<24h` 维持阶梯规则；`>24h` 必须按 `delta_start` 连续衰减（不能固定常数），避免“仅近 100~300m 但晚很多天”的地点反超更早开始地点。
- nearby 轮播推荐粗排阶段必须先过滤 `ended` 活动（仅保留 `upcoming/ongoing/unknown`）。
- nearby 轮播在当前阶段默认优先花火大会：同条件下 `hanabi` 高于 `matsuri`。

### 7.4 nearby 逻辑

- 不仅看当前视口：优先“扩展范围内但当前屏外”的地点。
- 意义：地图放大时仍提示稍远可去地点。
- 触发时机：仅在“用户地图拖动/缩放结束”后触发 nearby 重排，不在移动过程连续重排。
- 触发排除：marker 点击、quickCard 聚焦、定位重置等程序化相机变化不触发 nearby 重排。

### 7.5 地图与定位逻辑

- 测试阶段定位固定在隅田川/天空树附近。
- 首次加载定位点在视觉上位于屏幕中心偏下。
- 定位按钮用于快速回到当前定位点。

### 7.6 状态持久化逻辑

- `tsugie.placeState.v1`：收藏/打卡状态。
- `tsugie.colorScheme`：主题方案。
- `tsugie.themeAlphaRatio`：透明度比例。
- `tsugie.themeSaturationRatio`：饱和度比例。

---

## 8. 设计注意点（后续 iOS 必须延续）

### 8.1 视觉规范

- 地图是第一视觉层，不要被重型卡片长期遮挡。
- 胶囊类高亮统一为：无边框 + 渐变发光 + 朦胧立体感。
- 高亮颜色必须跟随主题，不可硬编码固定色。
- 普通模式默认清新渐变，不以暗色为默认模式。

### 8.2 信息密度规范

- quickCard 只放决策必要信息，不承载详情型说明。
- 日历日格只保留统计，不堆地点名。
- 时间信息避免重复表达（有时间范围时不再重复“开始/结束”句式）。

### 8.3 文案规范

- 用户可见文案优先日文在地化。
- 语气：诗意、克制、轻提示，不做过度营销式表达。
- 当日特判文案固定：`本日開催！まもなく！`。

### 8.4 语义边界规范

- `へ` 是语义层概念，不强制进入显示名。
- 花火只是首个垂类，不得在通用组件命名中硬编码“花火”。

---

## 9. iOS 实施映射（正式开发建议）

### 9.1 模块拆分建议

- `Domain`：
- `HePlace`、`HeType`、`EventStatus`、`PlaceState`、`ThemeState`。
- `Application`：
- 推荐排序、状态计算、倒计时、日历聚合、主题调节策略。
- `Infrastructure`：
- 本地存储（UserDefaults）、地图服务（MapKit）、通知服务（UNUserNotificationCenter）。
- `Presentation`：
- HomeMap、QuickCard、Detail、SideDrawer、FavoriteDrawer、CalendarPage、CalendarDayDrawer。

### 9.2 关键 ViewModel 建议

- `HomeMapViewModel`：地图点位、nearby、quickCard、detail、marker bubble。
- `CalendarViewModel`：月份构建、日格统计、当天抽屉、分类过滤。
- `DrawerViewModel`：右侧侧栏 + 左侧收藏抽屉 + 遮罩层级管理。
- `ThemeViewModel`：主题切换、透明度比例、饱和度、持久化。
- `PlaceStateStore`：收藏/打卡状态单一数据源。

### 9.3 关键逻辑迁移优先级

1. 先迁移统一状态计算（时间、倒计时、进度）。
2. 再迁移页面结构与互斥规则（主页、详情、日历独立页）。
3. 再接入收藏/打卡状态与抽屉层级逻辑。
4. 最后接入主题调节和细节动效。

### 9.4 iOS 技术实现要点

- 手势：使用 `DragGesture` 复刻 quick/detail 阈值。
- 地图：MapKit 点位 + 选中态视觉区分 + 回到定位点按钮。
- 持久化：UserDefaults 键名沿用现有键，减少迁移成本。
- 定时刷新：每秒 ticker 刷新当前 focus 相关状态（可用 `Timer.publish` + Combine）。
- 动画：底部卡片和详情页仅做位置过渡，避免透明度动画污染语义。

---

## 10. iOS MVP 开发顺序（建议）

1. 地图主页骨架（全屏地图 + 点位 + 顶部入口）。
2. quickCard 与详情页联动（含手势阈值）。
3. `resolveEventStatus` 与进度组件统一（先详情，再 quick，再列表）。
4. 日历独立页与日历日抽屉。
5. 收藏/打卡 + 地图气泡 + 收藏抽屉。
6. 主题体系（方案切换 + 透明度比例 + 饱和度）与本地持久化。
7. 本地通知（开始前提醒）和稳定性回归。

---

## 11. MVP 边界提醒（保持不扩）

- 不做账号/登录。
- 不做社交/评论。
- 不做复杂推荐算法。
- 不做路径优化和支付订阅。
- 不做多语言系统化扩展（当前以日文 UI 为主）。

---

## 12. 关键参考文档索引

- `需求/tsugihe_mvp_start_v0.1.md`
- `设计/文档/node-0-1-mvp详情页与状态演示归档-v3.md`
- `设计/文档/node-0-1-日历独立页与高亮规范归档-v4.md`
- `设计/文档/node-0-1-进度条强化与多场景一致性归档-v5.md`
- `设计/文档/node-0-1-时间呈现一致性与去冗余归档-v6.md`
- `设计/文档/node-0-1-打卡系统与收藏联动归档-v7.md`
- `设计/文档/node-0-1-色彩管理调节与顶栏定位归档-v8.md`
- `设计/文档/figma-语义命名与へ抽象规范-v1.md`
- `记录/项目变更记录.md`
