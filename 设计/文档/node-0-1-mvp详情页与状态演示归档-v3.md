# Node 0:1 MVP 详情页与状态演示归档 v3（可复现开发基线）

## 1. 文档目标
- 作为后续复现开发的强约束资料。
- 覆盖“需求拆解 -> 功能规格 -> 交互状态机 -> 数据模型 -> 视觉规则 -> 验收清单 -> 复现步骤”。
- 对应当前原型基线文件：
  - `设计/原型/main-screen.html`
  - `设计/原型/main-screen.css`

## 2. 本阶段需求（最终口径）
1. 首页主链路必须成立：
- 地图全屏展示地点点位。
- 点击点位打开底部 quickCard。
- 上划 quickCard，详情页从底部展开为全屏。

2. 详情页必须包含：
- 地点名、距离、开放时间。
- 活动时间状态（未开始/进行中/已结束）。
- 活动图。
- 地图 focus 小模块。
- 活动介绍。
- 热度、惊喜度。

3. 状态表达必须组件化：
- quickCard 和详情页共用同一进度组件语义。
- 进行中与未开始视觉可区分。
- quickCard 进行中允许轻量“朦胧发光”强调。

4. MVP 演示要求：
- 不同地点演示不同状态，便于一次性展示全链路能力。

## 3. 核心文件与职责
1. `设计/原型/main-screen.html`
- 页面结构、状态计算、地图渲染、手势交互、实时刷新。

2. `设计/原型/main-screen.css`
- 视觉样式、组件外观、动效、状态色层级。

3. `设计/原型/local-config.example.js`
- 本地地图 key 示例模板（不含真实 key）。

4. 本地代码快照（归档）
- `记录/归档/frontend-code-snapshots/2026-02-14-node-0-1-mvp-detail-progress-v3/`

## 4. 功能规格（可执行定义）
### 4.1 地图与点位
1. 地图模式
- 优先 Google JS 地图。
- 权限不满足时降级 Embed + overlay 点位。

2. 点位
- 点位文本显示真实地点名（不在名称里拼“へ”）。
- 点击点位后触发 quickCard 打开。
- 被选中点位需要高亮态（active）。

3. 当前定位
- 测试阶段定位固定在隅田川/天空树附近。
- 有“回到当前定位”按钮。

### 4.2 quickCard
1. 打开来源
- 点位点击。
- 附近轮播点击。
- 自动推荐延时弹出（2200ms）。

2. 必备内容
- 标题：地点名。
- 标题下：进度组件（仅进度，不附加说明文本）。
- 元信息：`距离 ・ 日期文案 ・ 开始-结束时间`。
- 提示文案与 CTA。

3. 日期特判
- 若活动开始日期是今天：`本日開催！まもなく！`。
- 否则显示 `YYYY-MM-DD`。

### 4.3 详情页
1. 打开方式
- quickCard 上划触发。
- quickCard 的“詳細を見る”按钮触发。

2. 关闭方式
- 顶部下拉手势。
- 右上角关闭按钮。

3. 内容结构
- 顶部：地点标题。
- 次级：距离 + 开放时间。
- 状态进度区块（含标题、meta、轨道、左右锚点文案）。
- 活动图（含标签和简述）。
- 地图 focus 模块。
- 介绍文本。
- 热度/惊喜度统计条。

## 5. 交互状态机
### 5.1 面板互斥规则
1. `quickCard` 可见时：`nearbyCarousel` 隐藏。
2. `detailPanel` 可见时：`quickCard` 与 `nearbyCarousel` 均隐藏。
3. `detailPanel` 关闭后：可恢复 `quickCard`（根据上下文）。

### 5.2 手势阈值（复现必须一致）
1. quickCard 上划打开详情
- 判定函数：`shouldExpandDetailBySwipe(delta, startAt)`。
- 条件一：`delta <= -44`。
- 条件二：`delta <= -20` 且耗时 `<= 220ms`。
- 拖拽位移夹取：`-190 ~ 50`。

2. 详情页下拉关闭
- pointer 分支：`delta >= 120` 触发关闭。
- touch 分支：`delta >= 110` 触发关闭。
- 拖拽位移夹取：`0 ~ 260`。

3. 兼容策略
- 支持 PointerEvent。
- 不支持时自动降级 touch 事件。

## 6. 状态与时间计算规格
### 6.1 状态枚举
- `upcoming`：未开始。
- `ongoing`：进行中。
- `ended`：已结束。
- `unknown`：时间信息缺失。

### 6.2 倒计时展示粒度
- `>= 1日`：`xx日xx时`。
- `< 1日 且 >= 1小时`：`xx时xx分xx秒`。
- `< 1小时 且 >= 5分钟`：`xx分xx秒`。
- `< 5分钟`：`xx秒`。

### 6.3 实时刷新
- 刷新周期：1000ms。
- 刷新目标：
  - quickCard `quickMeta`。
  - quickCard progress。
  - 详情页 progress 与状态文案。

## 7. 进度组件规范（统一组件）
### 7.1 统一结构
- `status-track`
- `status-fill`
- `status-endpoint`（内部仅 `status-he` 小胶囊）
- `status-face`（当前临时隐藏）

### 7.2 端点规则
- 端点为 `へ` 小胶囊。
- 边缘锚点规则：
  - `<= 8%` 用左锚点，防止溢出。
  - `>= 92%` 用右锚点，防止溢出。

### 7.3 quick 进行中发光规则
- 发光只在 `quick-progress-ongoing` 生效。
- 发光色必须与 fill 本色不同。
- 发光色计算方式：
  - 先按当前进度采样主题渐变色。
  - 再与白色混合，得到“偏白主题色”。
  - 输出半透明强/弱两档 glow 变量。

## 8. MVP 演示数据配置（测试态固定）
1. 隅田川花火大会
- 状态：`upcoming`
- 配置：`startInSec=28*60`，`durationSec=100*60`

2. 浅草サンバ祭
- 状态：`ongoing`
- 配置：`elapsedSec=30*60`，`durationSec=90*60`

3. 目黒川さくら並木
- 状态：`ended`
- 配置：`endedAgoSec=18*60`，`durationSec=110*60`

4. 神宮外苑いちょう並木
- 状态：`upcoming`（跨日）
- 配置：`startInSec=30*60*60`，`durationSec=80*60`

## 9. 视觉与文案注意点
1. quickCard
- 信息尽量短路径，不塞入详情解释型文案。
- `quickMeta` 负责“距离 + 日期 + 时间段”即可。

2. 详情页
- 承载完整信息，保持模块分区清晰。
- 状态区块保持轻底，避免大面积重底压迫地图产品气质。

3. 文案
- 优先日文本土表达。
- 当日特判文案固定为：`本日開催！まもなく！`。

## 10. 本地复现步骤
1. 准备
- 打开 `设计/原型/main-screen.html`。
- 可选：配置 `设计/原型/local-config.js` 的 `gmapsKey`。

2. 功能核验
- 点击点位 -> quickCard 打开。
- 上划 quickCard -> 详情页全屏。
- 下滑详情页 -> 返回 quickCard。
- 点击详情页 focus -> 地图回到对应点位。

3. 状态核验
- 隅田川显示未开始。
- 浅草显示进行中约 1/3。
- 目黑川显示已结束。
- 神宫外苑显示跨日未开始。

4. 时间核验
- 等待 3-5 秒，确认 quick 与 detail 的时间/进度持续刷新。

## 11. 验收清单
1. 交互验收
- 主链路无断点。
- 面板互斥正确。
- 手势在 pointer/touch 下均可用。

2. 状态验收
- 三种状态 UI 明确。
- 同一地点 quick 与 detail 状态一致。

3. 视觉验收
- `へ` 终端不溢出。
- quick 进行中 glow 颜色为偏白主题色，不与 fill 同色。

4. 文案验收
- 当日场景出现 `本日開催！まもなく！`。
- 非当日显示日期 `YYYY-MM-DD`。

## 12. 风险与后续
1. 已知风险
- 测试态时序依赖 `testTimeline`，未接入真实服务端时钟。
- Embed 降级模式下地图位移能力受限。

2. 后续建议
- 将时序计算抽为独立模块，降低页面脚本耦合。
- 封板后按 HTML-first 流程生成 schema 并批量同步 Figma。
