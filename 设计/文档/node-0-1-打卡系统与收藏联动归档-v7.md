# Node 0:1 打卡系统与收藏联动归档 v7

## 1. 阶段目标
- 建立「想去（收藏）/去过（打卡）」双状态闭环，并贯通地图点位、快速查看、详情页、日历抽屉、附近轮播与收藏管理。
- 将收藏入口从“右侧侧栏内容内展开列表”升级为“左侧独立收藏抽屉”，降低侧栏信息拥挤。
- 在视觉层完成地图点位操作的轻量化表达：弧形操作浮层 + 透明背景，避免遮挡地图语义。

## 2. 本阶段需求（最终口径）
1. 地图点位点击后先弹出操作气泡，可直接执行收藏/打卡，并支持进入 quickcard。
2. 所有涉及地点的展示卡片统一输出收藏/打卡状态，且仅用 logo，不使用文字状态。
3. 收藏语义固定为“想要访问”；打卡语义固定为“已经访问”。
4. 右侧侧栏中的收藏入口改为触发左侧收藏抽屉；抽屉支持“全部/未打卡/已打卡”筛选。
5. 收藏抽屉打开时，背景需有蒙砂遮罩并带颗粒纹理；只保留收藏抽屉在最上层。
6. 收藏抽屉展开后，点遮罩只关闭收藏抽屉，不关闭右侧侧栏。
7. 侧栏打开时默认不选中任何项，由用户主动选择。
8. 地图点位气泡改为弧形透明风格，去除整体边框与阴影。

## 3. 功能落地（当前实现）
### 3.1 地图点位操作改造
- fallback marker 与 Google marker 均改为点击后触发 `openMarkerActionBubble(place, mode)`。
- 气泡支持三动作：
- 收藏切换（★/☆）
- 打卡切换（◉/◌）
- 打开 quickcard（↗）
- 气泡关闭条件：点击地图空白、地图拖拽、打开 quickcard、切换日历页、Esc。

### 3.2 状态模型与持久化
- 新增 `placeStateMap`，按 `place.id` 保存：
- `favorite: boolean`
- `checkedIn: boolean`
- 新增本地存储键：`tsugie.placeState.v1`。
- 初始化时读取本地状态并与默认测试数据合并，确保 MVP 演示可见。

### 3.3 全场景状态图标化
- quickcard 头部新增状态图标容器（右上）。
- 详情页标题行新增状态图标容器（右侧）。
- nearby 卡片、日历某日抽屉条目、收藏抽屉条目统一接入同一状态图标组件。
- 规则：状态仅用 logo，不追加“已收藏/已打卡”文字。

### 3.4 收藏抽屉架构
- 左侧新增 `favorite-drawer`，独立于右侧 `side-drawer`。
- 右侧仅保留“入口语义”，不承载收藏列表内容本体。
- 收藏抽屉筛选：
- `all`（全部）
- `planned`（未打卡）
- `checked`（已打卡）
- 点击收藏条目可直接关闭抽屉并进入 quickcard。

### 3.5 遮罩与层级治理
- 收藏抽屉打开时，遮罩层级提升至右侧侧栏之上。
- 层级顺序：`favorite-drawer` > `backdrop` > `side-drawer` > 主页组件。
- 遮罩引入颗粒纹理叠层（radial + repeating-linear）并增加磨砂模糊。

### 3.6 交互细节修正
- 侧栏默认无激活项：打开后显示“请选择功能项”的中性提示。
- 收藏抽屉打开时，点击遮罩只关闭收藏抽屉；侧栏保持打开。
- Esc 行为同上：优先关闭收藏抽屉，再关闭侧栏。

## 4. 视觉与文案注意点
1. 语义优先：
- `へ` 是统一实体，展示名必须是地点真实名，不加“xxxへ”后缀。

2. 状态表达克制：
- 收藏/打卡状态只用图标，不用文字状态标签，避免卡片信息过载。

3. 地图优先：
- 点位操作浮层必须轻量，不可遮挡过大区域；本版采用弧形透明布局。

4. 抽屉关系明确：
- 收藏抽屉是“侧栏上的二级面板”，不是替代侧栏。
- 遮罩应隔离干扰层，但不能吞掉收藏抽屉本身的交互。

5. 本土化语气：
- 新增文案统一日文表达，语气保持“诗意、克制、轻提示”。

## 5. 关键实现点（代码锚点）
- 地图气泡与动作：`设计/原型/main-screen.html`
- 状态存储与切换：`设计/原型/main-screen.html`
- 收藏抽屉渲染与筛选：`设计/原型/main-screen.html`
- 侧栏默认无选中与分级关闭：`设计/原型/main-screen.html`
- 弧形气泡视觉与遮罩颗粒层：`设计/原型/main-screen.css`

## 6. 验收清单
1. 点击地图点位后先出现弧形透明操作浮层。
2. 在浮层中切换收藏/打卡，quickcard/详情/nearby/日历抽屉/收藏抽屉状态同步刷新。
3. 打开侧栏时默认无激活菜单项。
4. 收藏抽屉打开后，背景可见颗粒蒙砂；右侧侧栏被遮罩压住。
5. 收藏抽屉打开时点击空白仅收起收藏抽屉，不关闭侧栏。
6. Esc 键先收起收藏抽屉，再收起侧栏。

## 7. 关联文件
- `设计/原型/main-screen.html`
- `设计/原型/main-screen.css`
- `需求/tsugihe_mvp_start_v0.1.md`
- `AGENTS.md`
- `记录/项目变更记录.md`
- `记录/归档/2026-02-14-node-0-1-打卡系统与收藏联动阶段归档-v7.md`

## 8. 本地前端快照（不入库）
- `记录/归档/frontend-code-snapshots/2026-02-14-node-0-1-checkin-favorite-v7/`
