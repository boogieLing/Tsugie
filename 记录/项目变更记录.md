# 项目变更记录

## 2026-02-22
- iOS nearby 推荐算法升级为“动态热度 + 惊喜融合 + 进行中近场强优先”：
  - 变更内容：`HomeMapViewModel.nearbyRecommendationSignal` 从静态 `heat_score` 三因子评分升级为 `SpaceScore + TimeScore + DynamicHeatScore + DynamicSurpriseScore + OngoingNearBoost + ImminentUpcomingBoost` 复合评分；新增动态热度函数（开场前预热、进行中抬升、结束后冷却）与动态惊喜函数（进行中/临近开场增益、结束态衰减）；保留 `unknown` 不得高于已知时刻、`ended` 粗排过滤与 `hanabi` 类别优先规则。同步新增单测覆盖“惊喜分参与排序”和“进行中近场优先”。
  - 原因：当前推荐仅用静态热度且未融合惊喜度，导致“进行中且较近”活动优先级不稳定，不符合产品预期。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`ios开发/tsugie/tsugieTests/Presentation/HomeMap/HomeMapViewModelTests.swift`、`需求/tsugie-ios-dev-handoff-v1.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-22。

## 2026-02-21
- iOS 测试执行规范新增“禁并行 clone”（单模拟器）：
  - 变更内容：在 `AGENTS.md` 新增 `11.4 iOS 测试执行并发规范（强制）`，要求本地 `xcodebuild test` 默认显式使用 `-parallel-testing-enabled NO` 与 `-maximum-concurrent-test-simulator-destinations 1`，禁止未授权并行 clone。
  - 原因：并行 clone 会反复拉起多模拟器实例，造成研发过程噪音与资源干扰，影响调试体验与稳定性。
  - 影响范围：`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-21。
- iOS nearby 推荐排序新增“已知时刻优先 unknown”门禁：
  - 变更内容：`HomeMapViewModel.nearbyPlaces` 比较器新增时刻优先级硬规则：`unknown` 候选不得排在 `ongoing/upcoming` 之前（即使更近或评分更高）；新增回归测试 `testNearbyCarouselPrefersKnownTimeOverUnknownEvenIfUnknownIsCloser`；同步更新 `需求/tsugie-ios-dev-handoff-v1.md` 与 `AGENTS.md` 的推荐规则基线。
  - 原因：修复“时刻未定活动仅因距离近而排到 nearby 列表第一”的排序异常，保证推荐可解释性。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`ios开发/tsugie/tsugieTests/Presentation/HomeMap/HomeMapViewModelTests.swift`、`需求/tsugie-ios-dev-handoff-v1.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-21。

## 2026-02-20
- 数据端新增花火脏图指纹过滤（`banner1_069a0e3420` 视为无图）：
  - 变更内容：在 `数据端/scripts/enrich_event_content.py` 新增脏图指纹过滤，抓取阶段命中 `banner1_069a0e3420`（含 `01_banner1_069a0e3420.jpg` 及哈希后缀变体）时直接剔除，不再写入 `image_urls`；在 `数据端/scripts/export_ios_seed.py` 同步增加导出侧兜底过滤，历史批次命中该图也会按“无图”处理，不进入 iOS 图片 payload。
  - 原因：该图片为已确认脏图，多个花火活动重复命中会造成“有图”误判，影响卡片展示与质量口径。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`数据端/scripts/export_ios_seed.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-20。

## 2026-02-19
- 数据端润色链路拆分为双供应商（介绍 DeepSeek / 一句话 Kimi）并新增历史脏数据回刷过滤：
  - 变更内容：`数据端/scripts/enrich_event_content.py` 的 `openai` 路径改为“介绍与一句话分模型/分端点”调用：介绍走主配置（`OPENAI_*`），一句话可独立覆盖（`OPENAI_ONE_LINER_*`），中英补全翻译可独立覆盖（`OPENAI_TRANSLATION_*`）；新增 `--only-past-days`，支持仅处理 `event_date_start < today-N` 的历史活动重跑。同步将该能力接入批处理脚本与 `HANABI/OMATSURI` 抓取收尾入口参数透传；批处理脚本新增 `REQUEST_TIMEOUT_SEC` 并传递到内容增强脚本，避免慢模型翻译阶段超时。
  - 原因：按最新运行策略将介绍生成接入 DeepSeek（`deepseek-reasoner`）并将一句话描述接入 Kimi2，同时对开始时间在 31 天之前的历史活动执行全量重生成以清理脏数据。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`数据端/scripts/run_hanabi_codex_batches.sh`、`数据端/scripts/run_omatsuri_codex_batches.sh`、`数据端/HANABI/hanabi_crawler/cli.py`、`数据端/OMATSURI/omatsuri_crawler/cli.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- 数据端管理系统新增“内容历史重跑”任务纳管：
  - 变更内容：`数据端/HANABI/scripts/data_ops_console.py` 新增 `content_regen` 任务类型与 `POST /api/run/content_regen` 接口，支持按 `only_past_days` 等参数触发 `enrich_event_content.py` 并纳入 `/api/jobs` 进度监控与 `/api/job_log` 日志查看；前端“任务执行”区域新增“启动历史内容重跑”按钮与基础参数输入（天数阈值、QPS）。
  - 原因：此前外部脚本直跑不在管理系统 job 列表中，无法实时监控；需统一纳管到 Ops Console。
  - 影响范围：`数据端/HANABI/scripts/data_ops_console.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- 数据端润色链路接入 Kimi2（OpenAI 兼容模式）：
  - 变更内容：`数据端/scripts/enrich_event_content.py` 的 `openai` 路径新增 OpenAI 兼容 Chat Completions 解析（同时保留 Responses 解析）；`run_hanabi_codex_batches.sh`、`run_omatsuri_codex_batches.sh` 从写死 `codex` 改为可配置 `POLISH_MODE`（默认 `auto`），并新增 `OPENAI_MODEL/OPENAI_BASE_URL` 透传；`HANABI/OMATSURI` 抓取收尾入口新增 `--content-openai-model` 与 `--content-openai-base-url`，确保全量与补抓链路可直接切到 Kimi2。
  - 原因：按最新运行决策切换至 `kimi-k2-0905-preview`，以更低成本稳定生成介绍与一句话。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`数据端/scripts/run_hanabi_codex_batches.sh`、`数据端/scripts/run_omatsuri_codex_batches.sh`、`数据端/HANABI/hanabi_crawler/cli.py`、`数据端/OMATSURI/omatsuri_crawler/cli.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- 数据端 Codex 模型自动探测与最省可用模型选择：
  - 变更内容：`数据端/scripts/enrich_event_content.py` 新增 `codex_model=auto` 探测逻辑（独立临时目录探测，避免仓库上下文 token）；按候选顺序 `gpt-5-mini,gpt-4.1-mini,gpt-4o-mini,o4-mini,o3-mini,gpt-5` 选择首个可用模型，且支持 `CODEX_MODEL_CANDIDATES` 环境变量覆盖。`run_hanabi_codex_batches.sh`、`run_omatsuri_codex_batches.sh` 与 `HANABI/OMATSURI` 抓取收尾入口默认模型同步改为 `auto`，默认 `codex-timeout-sec` 同步提升到 `120`；内容输出里的 `polish_model` 记录改为实际解析后的模型值。
  - 原因：用户要求“先试可用模型，再用最省模型”；当前账号下多种 mini 模型不可用，需自动化规避手工反复试错并减少失败批次。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`数据端/scripts/run_hanabi_codex_batches.sh`、`数据端/scripts/run_omatsuri_codex_batches.sh`、`数据端/HANABI/hanabi_crawler/cli.py`、`数据端/OMATSURI/omatsuri_crawler/cli.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- 数据端 Codex 模型兼容修复（不支持模型自动回退）：
  - 变更内容：`数据端/scripts/enrich_event_content.py` 的 `CodexTextPolisher._call` 新增重试与错误透出，并在检测到“ChatGPT 账号不支持指定模型”时自动回退 `gpt-5`；同时将分批脚本与抓取收尾入口的默认 codex 模型从 `gpt-5-mini` 调整为 `gpt-5`（保留低频长跑与单次多语策略）。
  - 原因：当前运行环境对 `gpt-5-mini` 返回模型不支持，导致批量润色出现 `polish_error:empty codex polish response`。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`数据端/scripts/run_hanabi_codex_batches.sh`、`数据端/scripts/run_omatsuri_codex_batches.sh`、`数据端/HANABI/hanabi_crawler/cli.py`、`数据端/OMATSURI/omatsuri_crawler/cli.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- 数据端内容增强调度与低 token 口径强化（近期开场优先 + 单次多语）：
  - 变更内容：`数据端/scripts/enrich_event_content.py` 新增“近期开场优先”排序（未开始优先、其次已过期 31 天内）并在 `failed-only` 下优先处理仍需请求项；新增 `--prioritize-near-start` 与 `--codex-single-pass-i18n`，要求日/中/英介绍与一句话在单次 codex 调用返回，禁用二次翻译补调；默认 `codex_model` 下调为 `gpt-5-mini`。同时将该策略接入 `run_hanabi_codex_batches.sh`、`run_omatsuri_codex_batches.sh` 以及 `HANABI/OMATSURI` 全量抓取收尾入口（`*-crawler/cli.py`）。
  - 原因：按“开始时间近”优先补齐用户最关心活动，并在保留三语产出的前提下降低 token 成本。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`数据端/scripts/run_hanabi_codex_batches.sh`、`数据端/scripts/run_omatsuri_codex_batches.sh`、`数据端/HANABI/hanabi_crawler/cli.py`、`数据端/OMATSURI/omatsuri_crawler/cli.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- 数据端内容增强重跑策略优化（仅失败/未处理）：
  - 变更内容：`数据端/scripts/enrich_event_content.py` 新增 `--failed-only`（默认关闭，入口默认开启）模式；当开启时，仅对“失败/不完整/未处理”记录发起抓取与润色请求，已有成功记录直接复用并记为 `cached`。同时在 `content_summary.json` 新增 `counts.reused_by_failed_only` 与 `filter.failed_only` 便于追踪节省量。
  - 原因：降低重跑阶段的无效网络与模型请求，聚焦补齐缺口，缩短长跑任务总时长。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`数据端/scripts/run_hanabi_codex_batches.sh`、`数据端/scripts/run_omatsuri_codex_batches.sh`、`数据端/HANABI/hanabi_crawler/cli.py`、`数据端/OMATSURI/omatsuri_crawler/cli.py`、`数据端/HANABI/scripts/refresh_incomplete_events.py`、`数据端/OMATSURI/scripts/refresh_incomplete_events.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- 数据端内容增强时间过滤口径修正（仅按开始时间）：
  - 变更内容：`数据端/scripts/enrich_event_content.py` 的 `--skip-past-days` 过滤规则由“结束/开始时间择一”调整为“仅 `event_date_start`”；`start_date < today-31d` 直接跳过，保留“未开始”和“已过期 31 天内”活动继续处理；同步在 summary/filter 中标记 `basis=event_date_start`。
  - 原因：对齐最新运行策略，避免已过期较久活动继续消耗抓取与润色资源，同时确保近期活动仍可补齐图片与文案。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- 数据端管理系统增强（抓取进度监控 + 缺口分析 + macOS 风格 UI）：
  - 变更内容：`数据端/HANABI/scripts/data_ops_console.py` 增强管理台能力，新增 `/api/quality` 质量分析接口与任务进度推断（`/api/jobs` 增加 `progress`）；质量口径覆盖“未抓取（主抓失败 + 补抓失败）/开始时间未确定（日期或时间缺失）/无图片/无介绍/无一句话/内容条目缺失”；并将前端页面升级为 macOS 风格（窗口标题栏、玻璃拟态卡片、KPI 面板、进度条与缺口清单视图）。同时修复 `数据端/scripts/ops_console.sh` 的进程识别逻辑（支持按端口兜底回收 PID），避免“服务在跑但 status 显示 not running”。
  - 原因：需要在长时间低频任务中可视化“跑到哪一步”和“哪些数据还缺”，减少人工抽样排查成本，并保证运营口径可追溯。
  - 影响范围：`数据端/HANABI/scripts/data_ops_console.py`、`数据端/scripts/ops_console.sh`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- 数据端抓取收尾链路自动化（full/highfreq 自动内容增强 + 自动导出 iOS 资源包）：
  - 变更内容：在 `HANABI/OMATSURI` 的全量入口（`*-crawler/cli.py`）与高频补充入口（`scripts/refresh_incomplete_events.py`）新增默认收尾步骤：`fuse` 成功后自动调用 `数据端/scripts/enrich_event_content.py`（默认 `max_images=1`、低 QPS、回写 `latest_run.json`）；在统一运维入口 `HANABI/scripts/data_ops_console.py` 中新增任务后置步骤，`/api/run/full` 与 `/api/run/highfreq` 成功后自动执行 `bash 数据端/scripts/update_ios_payload.sh --pretty`，将“新抓取 + 内容增强”直接导入 `ios开发/tsugie/tsugie/Resources/`。
  - 原因：将“活动图片/介绍/一句话”从手动补跑改为抓取链路固定末尾步骤，确保全量与补充更新都自动完成内容增强，并把结果稳定接入 iOS App。
  - 影响范围：`数据端/HANABI/hanabi_crawler/cli.py`、`数据端/OMATSURI/omatsuri_crawler/cli.py`、`数据端/HANABI/scripts/refresh_incomplete_events.py`、`数据端/OMATSURI/scripts/refresh_incomplete_events.py`、`数据端/HANABI/scripts/data_ops_console.py`、`数据端/README.md`、`数据端/HANABI/README.md`、`数据端/OMATSURI/README.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- iOS 打卡时间门禁与顶部提示气泡落地（upcoming 不可打卡）：
  - 变更内容：`HomeMapViewModel.toggleCheckedIn` 新增活动时间状态拦截，`upcoming` 活动直接禁止打卡并展示提示文案；新增 `TopNotice` 状态与自动销毁任务，提示气泡从屏幕顶部中间向下弹出；在 `onViewDisappear/deinit` 中补充提示任务取消与状态清理，避免生命周期悬挂。
  - 原因：满足“未到开始时间不允许打卡”的业务规则，并补齐可感知的用户反馈与内存安全约束。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapView.swift`、`ios开发/tsugie/tsugie/App/Localization/L10n.swift`、`ios开发/tsugie/tsugie/Localization/{zh-Hans,en,ja}.lproj/Localizable.strings`、`ios开发/tsugie/tsugieTests/Presentation/HomeMap/HomeMapViewModelTests.swift`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- nearby 推荐候选池与地图渲染池解耦（支持视野外探索推荐）：
  - 变更内容：`HomeMapViewModel` 新增 `nearbyRecommendationPlaces` 候选池，`nearbyPlaces` 改为优先基于候选池排序，不再严格受 `renderedPlaces`（视野内渲染池）限制；在 `reloadRenderedPlaces` 内引入更大推荐包络（`nearbyRecommendationBufferScale=3.2`）并做上限裁剪（`maxNearbyRecommendationPlaces=420`），使“视野外但周边可达”地点可参与 nearby 推荐；`place(for:)` 增加候选池回查，保证视野外推荐项可正常进入 quickCard 链路。
  - 原因：修复“推荐范围必须严格处于相机视野内”导致探索引导不足的问题，满足“视野外地点参与推荐”的产品预期。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`ios开发/tsugie/tsugieTests/Presentation/HomeMap/HomeMapViewModelTests.swift`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- nearby 生命周期与内存管理补强（本轮配套）：
  - 变更内容：在 `onViewDisappear` 中主动清空 `nearbyRecommendationPlaces`；候选池更新统一通过限长替换函数，避免高频相机回调累积无界对象集合。
  - 原因：在扩大推荐范围的同时控制内存上界，降低长会话期间内存膨胀与生命周期悬挂风险。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。
- iOS 推荐算法回调到原始 V1 口径并修复“微小距离差压过显著时间差”：
  - 变更内容：`HomeMapViewModel` 的 nearby 评分权重由 `0.40/0.35/0.15/0.10` 回调为 `0.45/0.45/0.10`（Space/Time/Heat），类别权重回调为 `hanabi=1.2`、`matsuri=1.0`、`nature=0.8`、`other=1.0`；`upcoming` 在 `>24h` 区间改为按 `delta_start` 连续衰减，避免固定常数导致长周期活动被距离小幅优势反超；地图主推荐入口改为复用 nearby 评分链路，统一 Top1 选取口径。
  - 原因：复查发现当前实现与最初 `需求/Tsugie_Recommendation_Algorithm_V1.docx` 基线存在偏移，且出现“75 天 1.2km 排在 27 天 1.4km 前”的排序不符合产品预期。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`ios开发/tsugie/tsugieTests/Presentation/HomeMap/HomeMapViewModelTests.swift`、`需求/tsugie-ios-dev-handoff-v1.md`、`需求/Tsugie_Recommendation_Algorithm_V1_数据对齐修订.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-19。

## 2026-02-17
- 数据端新增“活动内容低频增强链路”（图片 + 介绍 + 一句话简述）：
  - 变更内容：新增统一脚本 `数据端/scripts/enrich_event_content.py`，基于 HANABI/OMATSURI 最新 `fused_run_id` 批次逐活动抓取详情页内容，提取 `raw_description` 与 `image_urls`，可选下载图片到本地，并输出 `events_content.jsonl/csv`、`content_enrich_log.csv`、`content_summary.json`；支持低频长跑参数（低 QPS、`min_refresh_days` 复用缓存、失败重试）。
  - 原因：现有链路只有结构化字段，缺少“活动介绍与图片”层；需要一条可长期维护、可低频增量更新的稳定内容链路。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`数据端/README.md`、`数据端/HANABI/README.md`、`数据端/OMATSURI/README.md`。
  - 执行时间：2026-02-17。
- 数据端润色提示词改为本地模板化管理（可直接编辑）：
  - 变更内容：新增本地提示词文档 `数据端/文档/event-description-polish.prompt.md` 与 `数据端/文档/event-one-liner.prompt.md`，脚本默认读取模板并替换 `{原始文本}`；支持 `openai/none` 模式切换。
  - 原因：后续语气、长度、风格规则需要频繁调整，模板化可避免每次改代码并保持可追溯。
  - 影响范围：`数据端/文档/event-description-polish.prompt.md`、`数据端/文档/event-one-liner.prompt.md`、`数据端/scripts/enrich_event_content.py`。
  - 执行时间：2026-02-17。
- AGENTS 基线新增“数据端活动内容抓取与润色”章节：
  - 变更内容：`AGENTS.md` 新增第 16 节，明确统一脚本入口、提示词路径、输出规范与变更同步要求。
  - 原因：该链路属于数据端端到端流程新增，需要纳入项目级强约束，避免后续执行口径漂移。
  - 影响范围：`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-17。

## 2026-02-16
- 地图交互触发推荐链路优化（仅移动结束触发 + 程序化相机变化不触发）：
  - 变更内容：`HomeMapViewModel` 新增程序化相机变化抑制窗口与目标区域匹配，点击 marker/quickCard 聚焦/Map 重建等程序化视角变化不再触发 `cameraMove` 侧的 nearby 重排；新增最小有效移动阈值（中心位移/缩放比），仅在用户移动结束且视口变化达到阈值时才触发重排。
  - 原因：拖动地图期间或程序化视角变更导致的重复推荐计算会放大内存压力，影响交互稳定性。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`需求/tsugie-ios-dev-handoff-v1.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-16。
- nearby 推荐规则补充：粗排过滤过期活动 + 花火优先：
  - 变更内容：将底部 nearby 轮播推荐链路调整为“粗排先过滤 `ended` 活动”；在评分与同分比较中提升 `hanabi` 优先级（类别权重上调并增加同分优先）；同步更新 `需求/tsugie-ios-dev-handoff-v1.md` 与 `需求/Tsugie_Recommendation_Algorithm_V1_数据对齐修订.md` 的推荐规则描述。新增/更新测试覆盖 nearby 排序结果（过期活动不进入结果、花火优先）。
  - 原因：避免过期活动占用轮播推荐位，同时满足当前阶段“优先推荐花火大会”的产品策略。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`ios开发/tsugie/tsugieTests/Presentation/HomeMap/HomeMapViewModelTests.swift`、`需求/tsugie-ios-dev-handoff-v1.md`、`需求/Tsugie_Recommendation_Algorithm_V1_数据对齐修订.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-16。
- iOS 底部 nearby 轮播排序切换到评分模型（仅影响轮播顺序）：
  - 变更内容：`HomeMapViewModel` 新增仅用于 nearby 轮播的评分排序信号（`SpaceScore + TimeScore + heat_score + scale_score`，含类别权重与低置信度坐标降权），并将 `nearbyCarouselItems` 改为按该评分输出；不改地图主推荐、quickCard 自动推荐、日历排序与 cluster 锚点排序。新增 `HomeMapViewModelTests.testNearbyCarouselUsesScoredRecommendationOrder` 覆盖轮播排序结果。
  - 原因：在不扩散业务风险的前提下先把推荐算法优化到可用程度，满足“仅影响底部轮播顺序”的迭代约束。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`ios开发/tsugie/tsugieTests/Presentation/HomeMap/HomeMapViewModelTests.swift`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-16。
- 推荐算法需求与 iOS 数据结构完成对齐修订（V1.1）：
  - 变更内容：新增 `需求/Tsugie_Recommendation_Algorithm_V1_数据对齐修订.md`，完成 `Tsugie_Recommendation_Algorithm_V1.docx` 到当前 iOS 内置数据包结构的字段对齐；明确“同义改名字段、缺失字段、低覆盖字段”；给出基于现状可执行的评分与过滤规则（V1.1），并在 `需求/tsugie-ios-dev-handoff-v1.md` 的 `7.3` 节新增引用与执行口径；在 `AGENTS.md` 新增“推荐算法数据对齐基线”章节。
  - 原因：当前数据包中 `expected_visitors` 与 `launch_scale` 覆盖率不足，直接按原始 V1 字段执行会导致推荐逻辑与真实数据脱节，需要形成“可落地、可追溯”的需求基线。
  - 影响范围：`需求/Tsugie_Recommendation_Algorithm_V1_数据对齐修订.md`、`需求/tsugie-ios-dev-handoff-v1.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-16。
- 数据端新增“重叠坐标脏数据联网重查”自动流程（抓取后融合阶段强制执行）：
  - 变更内容：在 HANABI/OMATSURI 的 `fuse_records` 流程中新增二次坐标修复步骤：对同坐标重叠且低置信度来源（`network_geocode*` / `pref_center_fallback` / `missing`）的记录进行逐条联网重查，基于 `prefecture/city/venue_name/venue_address/event_name` 组合查询重新定位；命中新坐标且与旧坐标不同时覆盖写回，并将 `geo_source` 标记为 `network_geocode_overlap_repair*`。
  - 原因：当前融合结果存在大量“不同活动被压到同一坐标”的脏数据，单次人工修补不可维护，必须固化为每次抓取后的自动质量门禁。
  - 影响范围：`数据端/HANABI/hanabi_crawler/fusion.py`、`数据端/OMATSURI/omatsuri_crawler/fusion.py`、`数据端/HANABI/hanabi_crawler/cli.py`、`数据端/OMATSURI/omatsuri_crawler/cli.py`。
  - 执行时间：2026-02-16。
- 坐标修复日志与运行指标新增（可审计）：
  - 变更内容：每个融合 run 新增输出 `geo_overlap_repair_log.csv`，记录原坐标、查询策略、查询词、缓存命中、返回坐标与错误信息；CLI 汇总新增 `overlap_groups_detected / overlap_rows_considered / overlap_repair_attempted / overlap_repair_resolved` 等指标。
  - 原因：保证修复过程可追溯、可复核，便于后续排查误修复与回归比较。
  - 影响范围：`数据端/HANABI/hanabi_crawler/fusion.py`、`数据端/OMATSURI/omatsuri_crawler/fusion.py`、`数据端/HANABI/hanabi_crawler/cli.py`、`数据端/OMATSURI/omatsuri_crawler/cli.py`、`记录/项目变更记录.md`、`AGENTS.md`。
  - 执行时间：2026-02-16。
- 导出前地理质量门禁脚本落地并纳入统一入口：
  - 变更内容：新增 `数据端/scripts/geo_overlap_quality_gate.py`，对最新 HANABI/OMATSURI 融合结果执行“重叠坐标高风险组”门禁；`数据端/scripts/update_ios_payload.sh` 默认先执行该门禁并在失败时阻断 iOS 数据包导出（支持 `--skip-geo-overlap-gate` 应急绕过）。
  - 原因：将坐标质量要求前置到导出阶段，避免问题数据进入 iOS 资源包。
  - 影响范围：`数据端/scripts/geo_overlap_quality_gate.py`、`数据端/scripts/update_ios_payload.sh`、`数据端/README.md`、`数据端/HANABI/README.md`、`数据端/OMATSURI/README.md`、`AGENTS.md`、`记录/数据端-坐标重叠质量门禁流程-v1.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-16。

## 2026-02-15
- iOS 数据接入技术方案文档化（补充内存优化细节）：
  - 变更内容：新增独立技术文档 `记录/tsugie-ios-全量内置实时附近检索技术方案-v1.md`，系统整理“全量内置 + 实时附近检索”方案，包括数据包结构、编解码链路、定位与启动加载流程、内存实测画像（天空树 + 30km）与后续优化路线；同步更新 `README.md`、`ios开发/README.md`、`数据端/README.md` 增加技术文档入口与内存摘要。
  - 原因：将当前接入方案与内存优化策略从临时沟通沉淀为长期可复用文档，降低后续维护与交接成本。
  - 影响范围：`记录/tsugie-ios-全量内置实时附近检索技术方案-v1.md`、`README.md`、`ios开发/README.md`、`数据端/README.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-15。

- iOS 首屏加载改为“全量内置 + 动态附近检索（Geohash）”：
  - 变更内容：`数据端/scripts/export_ios_seed.py` 升级为输出双文件包：`he_places.index.json`（Geohash 空间索引）+ `he_places.payload.bin`（二进制分片 payload，含 `offset/length`）；`ios开发/tsugie/tsugie/Infrastructure/EncodedHePlaceRepository.swift` 改为按当前位置实时计算附近 bucket 并随机读取对应分片，避免加载时完整解析大 JSON；`HomeMapViewModel` 改为启动异步加载（开发阶段默认天空树定位桩点），并新增 `AppLocationProvider` 以支持后续动态定位切换。
  - 原因：满足“全量内置 + 实时按定位附近检索”的性能目标，避免静态划分与全量启动加载。
  - 影响范围：`数据端/scripts/export_ios_seed.py`、`数据端/scripts/update_ios_payload.sh`、`ios开发/tsugie/tsugie/Infrastructure/EncodedHePlaceRepository.swift`、`ios开发/tsugie/tsugie/Infrastructure/AppLocationProvider.swift`、`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`ios开发/tsugie/tsugie/Resources/he_places.index.json`、`ios开发/tsugie/tsugie/Resources/he_places.payload.bin`、`ios开发/README.md`、`数据端/README.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-15。

- iOS 数据包维护入口脚本与运维清单补齐：
  - 变更内容：新增统一维护脚本 `数据端/scripts/update_ios_payload.sh`，将“导出 + 产物摘要校验（counts/size/hash/codec）”收敛为单命令；新增维护文档 `记录/ios-数据接入维护清单-v1.md`（最少命令、预提交检查、提交模板）；同步更新 `数据端/README.md`、`ios开发/README.md`、`AGENTS.md` 的默认执行入口。
  - 原因：降低后续数据更新的人为操作差异，确保数据接入维护流程可复制、可审计。
  - 影响范围：`数据端/scripts/update_ios_payload.sh`、`记录/ios-数据接入维护清单-v1.md`、`数据端/README.md`、`ios开发/README.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-15。

- iOS 内置数据包接入链路落地（HANABI + OMATSURI）：
  - 变更内容：新增数据导出脚本 `数据端/scripts/export_ios_seed.py`，将两个子项目最新 `fused` 数据自动汇总并输出到 `ios开发/tsugie/tsugie/Resources/he_places.pack.json`；导出链路固定为 `zlib` 无损压缩 + `xor_sha256_stream_v1` 混淆 + `base64` 编码；iOS 端新增 `ios开发/tsugie/tsugie/Infrastructure/EncodedHePlaceRepository.swift` 完成逆向解码与 `HePlace` 映射；`HomeMapViewModel` 默认优先加载资源包数据，失败时回退 `MockHePlaceRepository`。
  - 原因：将“爬虫融合数据”从离线文件形态接入到 iOS 可运行链路，并用可维护脚本固化更新流程，降低手工同步与后续维护成本。
  - 影响范围：`数据端/scripts/export_ios_seed.py`、`ios开发/tsugie/tsugie/Resources/he_places.pack.json`、`ios开发/tsugie/tsugie/Infrastructure/EncodedHePlaceRepository.swift`、`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`数据端/README.md`、`ios开发/README.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-15。

- 数据端统一管理系统入口上移到 `数据端/` 根目录：
  - 变更内容：新增统一脚本目录 `数据端/scripts/`，落地 `start_ops_console.sh` 与 `ops_console.sh` 作为 HANABI/OMATSURI 共用的一键启动与运维入口；`数据端/HANABI/scripts/` 保留兼容转发脚本；同步更新 `数据端/README.md`、`数据端/HANABI/README.md`、`数据端/OMATSURI/README.md` 启动路径。
  - 原因：统一数据端管理系统入口，避免只能在子项目目录启动带来的操作复杂度与路径歧义。
  - 影响范围：`数据端/scripts/`、`数据端/README.md`、`数据端/HANABI/scripts/`、`数据端/HANABI/README.md`、`数据端/OMATSURI/README.md`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-15。

- 数据端目录新增祭典独立子项目 `OMATSURI`：
  - 变更内容：在 `数据端/` 下新增与 `HANABI` 同级目录 `OMATSURI/`，并迁入 2026 祭典抓取规划与配置草案（站点清单、抓取配置、分站计划、字段映射）；新增 `数据端/OMATSURI/README.md` 作为后续实现入口。
  - 原因：将花火与祭典两个垂类抓取解耦，降低配置与代码耦合风险，便于独立迭代。
  - 影响范围：`数据端/OMATSURI/`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-15。

- iOS 文案/i18n 系统基线落地（中/英/日）：
  - 变更内容：新增统一本地化入口 `ios开发/tsugie/tsugie/App/Localization/L10n.swift`，新增三语资源文件 `Localization/{zh-Hans,en,ja}.lproj/Localizable.strings`；将地图页、quickCard、底部轮播、详情页、侧栏、日历页、状态解析器与 mock 文案接入 typed i18n；新增维护文档 `记录/tsugie-ios-i18n文案系统规范-v1.md`；`project.pbxproj` 的 `knownRegions` 补充 `ja`。
  - 原因：进入后续持续迭代阶段，需要统一文案入口与多语言机制，避免硬编码和语义漂移，降低维护成本。
  - 影响范围：`ios开发/tsugie/tsugie/`、`ios开发/README.md`、`记录/tsugie-ios-i18n文案系统规范-v1.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-15。
- iOS App Store 高压线“定期检查记录”新增（初期开发态）：
  - 变更内容：新增独立目录 `记录/高压线检查/`，并新增 `记录/高压线检查/tsugie-ios-appstore高压线定期检查-2026-02-15-v1.md`，按 `2.1/2.3/2.5.1/4.2/5.1` 口径沉淀当前代码风险、证据路径与后续复查触发条件。
  - 原因：当前尚未进入提审阶段，先建立可持续复查台账，避免临近提审集中返工。
  - 影响范围：`记录/高压线检查/`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-15。

## 2026-02-14
- iOS 研发规范新增“UI 1:1 复刻门禁”：
  - 变更内容：在 `AGENTS.md` 的 iOS 阶段强约束中新增“已封板原型 + CSS”1:1 复刻要求；在 UI 优化阶段新增“逐项对照原型 CSS 验收”规则；在 `ios开发/README.md` 同步加入 UI 1:1 约束。
  - 原因：将“UI 一致性”从执行习惯升级为显式门禁，避免迭代中出现主观偏离。
  - 影响范围：`AGENTS.md`、`ios开发/README.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- iOS 发光效果统一方案沉淀与复用文档新增：
  - 变更内容：新增 `记录/tsugie-ios-发光效果复用规范-v1.md`，固化统一发光入口 `tsugieActiveGlow`、参数档位、组件接入清单、验收清单与 SwiftUI 参考 case；并将本轮已落地的地图/quickcard/轮播/侧栏/日历状态图标发光接入点归档。
  - 原因：将“已验证可用的强发光实现”转为可复用标准，减少后续 UI 优化重复试错成本。
  - 影响范围：`记录/tsugie-ios-发光效果复用规范-v1.md`、`ios开发/tsugie/tsugie/Presentation/HomeMap/`、`ios开发/tsugie/tsugie/Presentation/Calendar/CalendarPageView.swift`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- iOS 子目录入口文档同步三段流程与 Skill 预检门禁：
  - 变更内容：更新 `ios开发/README.md`，加入“研发实现 -> UI 优化 -> 安全/提审审查”三段流程，并明确每阶段开始前必须先进行 skill 检索与选型，补充关联执行文档入口。
  - 原因：确保根目录与 iOS 子目录入口规范一致，避免执行口径不一致。
  - 影响范围：`ios开发/README.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- iOS 三段流程新增“阶段启动 Skill 预检”门禁：
  - 变更内容：在 `AGENTS.md` 的 iOS 三段流程中增加强制门禁：每个阶段开始前必须先检索并选定适用 skill；在 `README.md` 同步新增该门禁说明与默认检索命令。
  - 原因：避免阶段执行时遗漏可复用能力，提升实现效率与质量一致性。
  - 影响范围：`AGENTS.md`、`README.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- iOS 研发流程统一为“三段式门禁”（研发 -> UI 优化 -> 安全/提审审查）：
  - 变更内容：在 `AGENTS.md` 新增“iOS 研发统一三段流程（强制）”，明确单次迭代默认执行顺序与每段门禁；在 `README.md` 增加同流程入口说明，并关联 `记录/tsugie-ios-ui美化技能编排流程-v1.md` 与 `ios开发/tsugie/tsugie/APP_STORE_PRECHECK.md`。
  - 原因：将“实现、体验、合规”从隐式习惯升级为显式流程，减少迭代中后置返工与提审风险。
  - 影响范围：`AGENTS.md`、`README.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- iOS 骨架并入 `tsugie` 主工程（移除 mvp 独立目录）：
  - 变更内容：将第一阶段 SwiftUI 骨架从 `ios开发/tsugie-swiftui-mvp/` 并入 `ios开发/tsugie/tsugie/`，目录统一为 `App / Domain / Application / Infrastructure / Presentation`；删除重复 `@main` 入口，仅保留 `tsugieApp.swift` 作为唯一入口并挂载 `RootView`。
  - 原因：正式进入 `tsugie` 主线开发，避免“mvp/正式工程”双轨并行导致的维护和认知成本。
  - 影响范围：`ios开发/tsugie/tsugie/`、`ios开发/README.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- iOS 第一阶段骨架落地（地图首页 + 点位 + quickCard）：
  - 变更内容：在 `ios开发/tsugie-swiftui-mvp/` 新增 SwiftUI 骨架，按 `App / Domain / Application / Infrastructure / Presentation` 分层组织；落地地图首页点位展示、点位点击触发 quickCard、收藏/打卡状态切换与本地持久化（`tsugie.placeState.v1`）；新增时间状态同源模型 `upcoming / ongoing / ended / unknown` 与统一解析器；新增“時めぐり”独立页面占位以固定地图/日历语义边界。
  - 原因：进入正式 iOS 开发阶段，先完成可执行的第一阶段骨架，为后续详情页手势闭环、日历页和收藏抽屉联动提供稳定基线。
  - 影响范围：`ios开发/README.md`、`ios开发/tsugie-swiftui-mvp/`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- iOS 阶段文档基线补齐（AGENTS/README）：
  - 变更内容：更新 `AGENTS.md`，新增“iOS 开发阶段基线（强制）”并明确以 `需求/tsugie-ios-dev-handoff-v1.md` 为执行入口；更新 `README.md` 为 iOS 启动阶段说明，补齐 v1~v8 进度与 iOS 开发入口索引。
  - 原因：把“进入 iOS 开发阶段”的执行约束前置到仓库主入口文档，降低后续实现偏差。
  - 影响范围：`AGENTS.md`、`README.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- iOS 开发阶段交接总纲新增：
  - 变更内容：新增 `需求/tsugie-ios-dev-handoff-v1.md`，统一汇总历史需求、语义规范、页面与组件清单、交互状态机、关联逻辑（时间/进度/收藏打卡/日历/主题）及 iOS 实施映射与开发顺序。
  - 原因：结束高频原型迭代后进入正式 iOS 开发，需要单一入口文档降低实现分歧并提升复现效率。
  - 影响范围：`需求/tsugie-ios-dev-handoff-v1.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- Node `0:1` 色彩管理调节与顶栏定位阶段归档（v8）：
  - 变更内容：侧栏配色管理新增“透過比率（透明度比例）”与“彩度”两条滑动条，支持实时调节并本地持久化；主题渲染改为 `--theme-live-*` 动态 token 输出；定位按钮移入顶栏并调整至 `top-kaomoji` 左侧且同高；完成 v8 阶段文档与本地快照归档。
  - 原因：增强配色系统的可控性与可调性，减少固定主题下的视觉僵化；统一顶栏控制节奏并提升操作一致性。
  - 影响范围：`设计/原型/main-screen.html`、`设计/原型/main-screen.css`、`设计/文档/node-0-1-色彩管理调节与顶栏定位归档-v8.md`、`记录/归档/2026-02-14-node-0-1-色彩管理调节与顶栏定位阶段归档-v8.md`、`记录/归档/frontend-code-snapshots/2026-02-14-node-0-1-theme-controls-v8/`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- Node `0:1` 打卡系统与收藏联动阶段归档（v7）：
  - 变更内容：完成地图点位操作气泡（收藏/打卡/进入 quickcard）、地点状态 logo 全链路透出（quickcard/详情/nearby/日历抽屉/收藏抽屉）、左侧收藏抽屉与“全部/未打卡/已打卡”筛选、本地状态持久化；并修正为“侧栏打开默认不选中任何项”“收藏抽屉打开时遮罩覆盖右侧侧栏与主页层（颗粒蒙砂）”“点击遮罩仅关闭收藏抽屉不关闭侧栏”；完成 v7 阶段文档与本地快照归档。
  - 原因：将“想去/去过”语义落地为可执行交互闭环，降低主页面板拥挤与状态分裂，保证后续地点详情与推荐策略可复用同一状态底座。
  - 影响范围：`设计/原型/main-screen.html`、`设计/原型/main-screen.css`、`设计/文档/node-0-1-打卡系统与收藏联动归档-v7.md`、`记录/归档/2026-02-14-node-0-1-打卡系统与收藏联动阶段归档-v7.md`、`记录/归档/frontend-code-snapshots/2026-02-14-node-0-1-checkin-favorite-v7/`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- Node `0:1` 打卡系统与收藏联动（左侧收藏抽屉）：
  - 变更内容：地图点位点击改为先弹出操作气泡，支持收藏/打卡切换并可进入 quickcard；地点状态（收藏/打卡）以 logo 形式接入 quickcard、详情页、附近轮播、日历某日抽屉、收藏抽屉；右侧“行きたい栞”改为触发左侧收藏抽屉，新增“全部/未打卡/已打卡”筛选；收藏与打卡状态本地持久化。
  - 原因：建立“想去/去过”双状态闭环，增强地点决策连续性，并将收藏能力从单栏展示升级为独立抽屉管理。
  - 影响范围：`设计/原型/main-screen.html`、`设计/原型/main-screen.css`、`AGENTS.md`、`需求/tsugihe_mvp_start_v0.1.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- Node `0:1` 时间呈现一致性与去冗余阶段归档（v6）：
  - 变更内容：quickcard 新增标题行双列布局（地点名在左、活动时间范围在右）；nearby 倒数逻辑切换为详情页同源状态输出（`leftLabel/rightLabel`）；日历某日抽屉新增倒数行并移除开始/结束重复文案，仅保留“时间范围 + 倒数状态”；补齐阶段归档文档与本地前端快照。
  - 原因：统一跨模块时间语义，减少重复信息，提高首屏与时间维度列表的信息效率和可读性。
  - 影响范围：`设计/原型/main-screen.html`、`设计/原型/main-screen.css`、`设计/文档/node-0-1-时间呈现一致性与去冗余归档-v6.md`、`记录/归档/2026-02-14-node-0-1-时间呈现一致性与去冗余阶段归档-v6.md`、`记录/归档/frontend-code-snapshots/2026-02-14-node-0-1-time-presentation-v6/`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- Node `0:1` 进度条强化与一致性修复阶段归档（v5）：
  - 变更内容：完成 `nearbyTrack`、日历某日抽屉列表、收藏列表（进行中）三处进度条接入；将列表进度条定位链路统一为详情页同源 `setProgressPosition`；修复轨道宽度塌陷导致端点固定左侧问题；新增“超过 1 日才开始的 upcoming 不展示进度条”规则；补齐阶段归档文档与本地前端快照。
  - 原因：强化状态感知的一致性与可读性，消除跨场景进度语义漂移和定位异常，确保后续新增列表场景可复用同一机制。
  - 影响范围：`设计/原型/main-screen.html`、`设计/原型/main-screen.css`、`设计/文档/node-0-1-进度条强化与多场景一致性归档-v5.md`、`记录/归档/2026-02-14-node-0-1-进度条强化与一致性修复阶段归档-v5.md`、`记录/归档/frontend-code-snapshots/2026-02-14-node-0-1-progress-visibility-v5/`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- Node `0:1` 日历独立页与高亮规范阶段归档（v4）：
  - 变更内容：完成日历从“叠加面板”到“独立页面切换”的交互模型重构；落地传统月历结构（按月分块、周日开头、7列日格、连续纵向滚动）；将日格内容收敛为分类统计；完成今日高亮主题联动；统一胶囊高亮为“无边框 + 渐变发光 + 朦胧立体感”；增加主题方案本地持久化；新增阶段总结文档、归档索引与本地前端快照。
  - 原因：解决主页与日历状态串扰，明确时间维度页面语义，并建立可复用的高亮视觉基线。
  - 影响范围：`设计/原型/main-screen.html`、`设计/原型/main-screen.css`、`设计/文档/node-0-1-日历独立页与高亮规范归档-v4.md`、`记录/归档/2026-02-14-node-0-1-日历独立页与高亮规范阶段归档-v4.md`、`记录/归档/frontend-code-snapshots/2026-02-14-node-0-1-calendar-page-highlight-v4/`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- 配色方案规范升级（胶囊高亮强制规则）：
  - 变更内容：将“胶囊类型高亮”固化为研发规范，统一为 `无边框 + 渐变发光背景 + 朦胧立体感`，且颜色必须跟随当前主题方案；禁止固定色与纯描边高亮。
  - 原因：保证跨页面、跨组件视觉一致性，减少后续实现分歧与返工。
  - 影响范围：`AGENTS.md`、`设计/文档/figma-语义命名与へ抽象规范-v1.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- Node `0:1` 日历页交互模型修正为独立页面切换：
  - 变更内容：将“日历面板叠加主页”的实现调整为“日历独立页面切换”；进入日历时主页组件整体隐藏且不改内部状态，关闭日历后恢复原状态；日历当日列表改为日历专属抽屉（不复用主页侧栏）。
  - 原因：消除日历与主页组件状态串扰（如 quickCard/detail 干扰）并降低交互复杂度。
  - 影响范围：`设计/原型/main-screen.html`、`设计/原型/main-screen.css`、`需求/tsugihe_mvp_start_v0.1.md`、`设计/文档/node-0-1-时间维度日历语义与交互-v1.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- Node `0:1` 新增时间维度日历（時めぐり）能力：
  - 变更内容：在主页右上角新增 `時めぐり` 入口；新增全屏日历页（时间维度语义）；按天展示最近且最快开始的 2 条 `へ`；每日右上角新增分类统计（含 logo 占位）；点击某一天后从右侧侧栏弹出当天 `へ` 并支持按分类过滤（默认“全部”）；补齐语义与交互说明文档。
  - 原因：补足“地图位置维度”之外的“时间维度”决策入口，降低用户按日期规划时的信息切换成本。
  - 影响范围：`设计/原型/main-screen.html`、`设计/原型/main-screen.css`、`需求/tsugihe_mvp_start_v0.1.md`、`AGENTS.md`、`设计/文档/node-0-1-时间维度日历语义与交互-v1.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。
- Node `0:1` 侧栏与配色方案阶段归档（v3）：
  - 变更内容：完成右侧侧栏交互（收藏/通知/联系）、选中态发光强化（选中无边框）、顶部配色胶囊与配色方案块（纯颜色展示）以及多主题一键切换；新增阶段总结文档、归档索引与本地前端快照。
  - 原因：将近期高频 UI 微调固化为可复现资料，确保后续收藏闭环、通知落地与主题 token 化迭代有稳定基线。
  - 影响范围：`设计/文档/node-0-1-侧栏与配色方案归档-v3.md`、`记录/归档/2026-02-14-node-0-1-侧栏与配色方案阶段归档-v3.md`、`记录/归档/frontend-code-snapshots/2026-02-14-node-0-1-side-drawer-theme-v3/`、`设计/原型/main-screen.html`、`设计/原型/main-screen.css`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。

## 2026-02-13
- 完成根目录重构：`设计/`、`ios开发/`、`数据端/`、`需求/`、`记录/`。
- 迁移历史文件到新结构：
  - `demand/tsugihe_mvp_start_v0.1.md` -> `需求/tsugihe_mvp_start_v0.1.md`
  - `Figma/tsugihe_main_screen_wireframe.svg` -> `设计/figma/tsugihe_main_screen_wireframe.svg`
  - `docs/ui-adjustment-checklist.md` -> `设计/文档/ui-adjustment-checklist.md`
  - `src/ui/main-screen.html` -> `设计/原型/main-screen.html`
  - `src/ui/main-screen.css` -> `设计/原型/main-screen.css`
- `AGENTS.md` 已升级为项目管理基线文档，纳入需求目标、组织方式、工作流程与大变动同步更新机制。
- 新增 Figma 节点 `1:2` 参考文档：`设计/figma/node-1-2-reference.md`（用于后续仅 Figma 侧 UI 调整）。
- 交互规则调整（Node `1:2`）：
  - 变更内容：首屏由“自动弹出推荐卡片”改为“默认全屏地图”；点击标记后弹出“快速查看”卡片。
  - 原因：突出地图优先与决策优先，减少首次进入的信息遮挡与认知负担。
  - 影响范围：`需求/tsugihe_mvp_start_v0.1.md`、`AGENTS.md`、`设计/figma/node-1-2-reference.md`、`设计/文档/node-1-2-figma-adjustment-v2.md`。
  - 执行时间：2026-02-13。
- Figma 自动化链路新增（Codex -> schema -> Plugin）：
  - 变更内容：新增独立子项目 `设计/figma-json-bridge/`，包含 Figma Plugin、schema 规范、示例与校验脚本。
  - 原因：将“Codex 产出 JSON -> Figma 自动落图”流程产品化，减少手工改图成本并提升可重复性。
  - 影响范围：`设计/figma-json-bridge/`、`AGENTS.md`。
  - 执行时间：2026-02-13。
- Figma Plugin 覆盖范围扩展（v1.1）：
  - 变更内容：从“示例节点支持”扩展到“尽量覆盖所有可更新节点/属性”，新增多节点类型、图片填充、实例节点与更多样式属性更新能力。
  - 原因：满足“不是举例，需尽量全覆盖”的执行要求，减少二次手工补改。
  - 影响范围：`设计/figma-json-bridge/plugin/code.js`、`设计/figma-json-bridge/schema/ui-schema.v1.schema.json`、`设计/figma-json-bridge/scripts/validate-ui-schema.js`、`设计/figma-json-bridge/README.md`、`设计/figma-json-bridge/prompts/codex-ui-schema-prompt.md`、`AGENTS.md`。
  - 执行时间：2026-02-13。
- Figma JSON Bridge 正式接入研发流程：
  - 变更内容：新增 `记录/figma-json-bridge研发接入SOP.md`，并在 `AGENTS.md` 增加强制执行条款。
  - 原因：将插件使用从“可选工具”升级为“标准执行路径”，确保改稿可追溯、可复现。
  - 影响范围：`记录/figma-json-bridge研发接入SOP.md`、`AGENTS.md`、`设计/figma-json-bridge/README.md`。
  - 执行时间：2026-02-13。
- Node `1:18` UI 优化与领域抽象升级：
  - 变更内容：新增地图优先 + 延时“最速攻略”方案 schema，建立统一配色系统与「へ」语义命名规范，并将需求文档从“花火活动”抽象为通用「へ」实体。
  - 原因：支持当前花火场景的同时，为后续扩展到其他地点类型预留统一模型和流程。
  - 影响范围：`设计/figma-json-bridge/schema/ui-schema.node-1-18.map-first-fast-guide.v1.json`、`设计/figma-json-bridge/schema/color-system.tsugie-he.v1.json`、`设计/文档/figma-语义命名与へ抽象规范-v1.md`、`设计/文档/node-1-18-ui优化执行单-v1.md`、`设计/figma/node-1-18-reference.md`、`需求/tsugihe_mvp_start_v0.1.md`、`AGENTS.md`、`README.md`、`设计/文档/ui-adjustment-checklist.md`、`设计/figma-json-bridge/README.md`。
  - 执行时间：2026-02-13。
- Figma 插件导入能力增强：
  - 变更内容：`Tsugie UI Schema Bridge` 新增“导入本地 JSON”功能，可直接选择本地 schema 文件加载。
  - 原因：减少手工复制粘贴大 JSON 的出错率，提高应用效率。
  - 影响范围：`设计/figma-json-bridge/plugin/ui.html`、`设计/figma-json-bridge/README.md`。
  - 执行时间：2026-02-13。
- Node `2:29` 地图样式优化与清新主题切换：
  - 变更内容：新增 `node-2-29` 的地图优先 schema，补齐示例地图层、优化点位样式（halo + core + label）、默认切换到清新渐变普通模式，并明确点位展示名使用真实地点名（不使用“xxxへ”）。
  - 原因：解决现有样式过暗、点位不易识别与展示命名不符合语义的体验问题。
  - 影响范围：`设计/figma-json-bridge/schema/ui-schema.node-2-29.map-first-fresh-gradient.v1.json`、`设计/figma-json-bridge/schema/color-system.tsugie-he.v2.fresh.json`、`设计/figma/node-2-29-reference.md`、`设计/文档/node-2-29-ui优化执行单-v1.md`、`设计/文档/figma-语义命名与へ抽象规范-v1.md`、`需求/tsugihe_mvp_start_v0.1.md`、`AGENTS.md`、`README.md`、`设计/figma-json-bridge/README.md`、`设计/figma-json-bridge/prompts/codex-ui-schema-prompt.md`、`设计/文档/ui-adjustment-checklist.md`。
  - 执行时间：2026-02-13。
- Figma 插件新增 color-system 应用模式：
  - 变更内容：`Tsugie UI Schema Bridge` 新增 `校验 color-system` 与 `应用 color-system 到托管节点`，支持在不重建节点的前提下批量刷新托管节点主题色。
  - 原因：解决“导入 color-system 文件时无法直接生效”的使用阻塞，提升主题迭代效率。
  - 影响范围：`设计/figma-json-bridge/plugin/code.js`、`设计/figma-json-bridge/plugin/ui.html`、`设计/figma-json-bridge/README.md`、`AGENTS.md`。
  - 执行时间：2026-02-13。
- Figma 插件新增 color-system 全局应用模式：
  - 变更内容：新增 `全文件应用 color-system`，可遍历当前文件全部页面并更新托管节点主题色。
  - 原因：支持跨页面统一换肤，避免逐页重复操作。
  - 影响范围：`设计/figma-json-bridge/plugin/code.js`、`设计/figma-json-bridge/plugin/ui.html`、`设计/figma-json-bridge/README.md`、`AGENTS.md`。
  - 执行时间：2026-02-13。
- UI 研发流程切换为“HTML 先行 -> Figma 批量落图”：
  - 变更内容：新增 `记录/ui-html-first-figma-batch-sop.md`，明确 UI 需求先在 `设计/原型/` 迭代，待你确认封板后再一次性生成 schema 并落 Figma。
  - 原因：减少反复改稿造成的 Figma 噪音，提升集中落图效率与可追溯性。
  - 影响范围：`记录/ui-html-first-figma-batch-sop.md`、`AGENTS.md`、`设计/figma-json-bridge/README.md`。
  - 执行时间：2026-02-13。
- Node `0:1` 首页原型阶段归档完成：
  - 变更内容：新增前端实现、功能说明、交互说明三份阶段文档，并在 `记录/归档/` 生成阶段归档索引。
  - 原因：固化当前地图优先页面能力，便于后续按同一基线继续迭代与落 Figma。
  - 影响范围：`设计/文档/node-0-1-前端实现归档-v1.md`、`设计/文档/node-0-1-功能文档归档-v1.md`、`设计/文档/node-0-1-交互文档归档-v1.md`、`记录/归档/2026-02-13-node-0-1-页面阶段归档-v1.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-13。
- Node `0:1` 前端代码快照归档补充：
  - 变更内容：新增本地前端代码快照目录 `记录/归档/frontend-code-snapshots/2026-02-13-node-0-1-main-screen-v1/`，并将 `记录/归档/frontend-code-snapshots/` 加入 `.gitignore`。
  - 原因：补齐“文档归档 + 代码归档”双轨，且避免快照目录误入版本库。
  - 影响范围：`.gitignore`、`记录/归档/2026-02-13-node-0-1-页面阶段归档-v1.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-13。
- Node `0:1` 详情页与状态演示阶段归档（v2）：
  - 变更内容：完成地图->quickCard->详情页链路、状态进度组件、MVP 多状态演示配置的阶段归档，并新增本地前端代码快照 `记录/归档/frontend-code-snapshots/2026-02-13-node-0-1-detail-progress-v2/`。
  - 原因：将近期高频 UI/交互迭代固化为可追溯基线，支撑后续 Figma 批量同步与验收。
  - 影响范围：`设计/文档/node-0-1-mvp详情页与状态演示归档-v2.md`、`记录/归档/2026-02-13-node-0-1-详情页与状态演示阶段归档-v2.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-13。
- Node `0:1` 详情页与状态演示归档升级（v3，可复现资料）：
  - 变更内容：将阶段总结升级为“可复现开发资料”，补齐需求拆解、功能规格、交互状态机、手势阈值、状态计算规则、MVP 演示配置、验收清单与本地复现步骤；新增 v3 归档索引与 v3 本地代码快照。
  - 原因：满足后续复现开发与多轮迭代对“细粒度、可执行文档”的要求。
  - 影响范围：`设计/文档/node-0-1-mvp详情页与状态演示归档-v3.md`、`记录/归档/2026-02-14-node-0-1-详情页与状态演示阶段归档-v3.md`、`记录/归档/frontend-code-snapshots/2026-02-14-node-0-1-mvp-detail-progress-v3/`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-14。

## 2026-02-18
- 数据端活动内容增强链路修复（祭典同图/乱码/本地润色）：
  - 变更内容：`数据端/scripts/enrich_event_content.py` 新增编码探测解码（含 `Shift_JIS/CP932` 回退），修复 `omatsuri.com` 页面文本乱码；新增 `--polish-mode codex`，支持本地逐条调用 Codex CLI 生成“介绍 + 一句话”；祭典月历锚点页改为优先提取活动行级文本，并过滤通用头图/OGP 图（如 `header.jpg`、`ogp0.png`），避免全活动复用同一张图。
  - 原因：线上观测到祭典详情出现“统一图片 + 文本乱码 + 未按提示词润色”问题，需要从抓取与润色链路根修。
  - 影响范围：`数据端/scripts/enrich_event_content.py`、`AGENTS.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-18。
- iOS 内置数据包接入补充（活动内容增强 + 单图接入）：
  - 变更内容：在 `数据端/scripts/export_ios_seed.py` 保持现有导出主链路不变的前提下，新增内容增强字段透传（`content_description`、`content_one_liner`、`content_source_urls`、`content_description_source_url`），并新增单图二进制资源输出 `ios开发/tsugie/tsugie/Resources/he_images.payload.bin`（每活动最多 1 张图，JPEG 压缩后按偏移索引）。
  - 原因：将已抓取图片与生成文案接入 iOS 详情页，同时控制包体与运行时内存占用。
  - 影响范围：`数据端/scripts/export_ios_seed.py`、`数据端/scripts/update_ios_payload.sh`、`ios开发/tsugie/tsugie/Resources/he_places.index.json`、`ios开发/tsugie/tsugie/Resources/he_places.payload.bin`、`ios开发/tsugie/tsugie/Resources/he_images.payload.bin`。
  - 执行时间：2026-02-18。
- iOS 详情页内容与图片展示策略更新：
  - 变更内容：`HePlace` 模型与 `EncodedHePlaceRepository` 增加活动介绍/一句话/来源链接/图片索引字段；详情页接入来源链接与一句话；新增 `HePlaceImageRepository` 按需解码图片；无图活动不渲染图片区；详情页不提供放大查看交互。
  - 原因：满足“有内容就展示、无图不占位、只接 1 张图、避免无效内存驻留”的接入要求。
  - 影响范围：`ios开发/tsugie/tsugie/Domain/Models/HePlace.swift`、`ios开发/tsugie/tsugie/Infrastructure/EncodedHePlaceRepository.swift`、`ios开发/tsugie/tsugie/Infrastructure/HePlaceImageRepository.swift`、`ios开发/tsugie/tsugie/Presentation/HomeMap/Components/DetailPanelView.swift`、`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、本地化文案文件。
  - 执行时间：2026-02-18。

## 2026-02-22
- iOS 隐私政策法务化口径升级（三语）：
  - 变更内容：隐私政策页面三语文案补充“单机本地优先 + 非互联网信息服务边界 + 合规知悉 + 适用法律 + 法律责任”，并统一首屏声明、数据处理边界与免责限制表述；首次隐私确认弹窗三语同步为同口径。
  - 原因：收敛“表述绝对化/免责过度/地域法律范围含糊”风险，提升提审与合规一致性。
  - 影响范围：`/Volumes/R0sORICO/work_dir/r0website_screen/src/screens/TsugiePrivacy/index.js`、`ios开发/tsugie/tsugie/Localization/zh-Hans.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/Localization/en.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/Localization/ja.lproj/Localizable.strings`。
  - 执行时间：2026-02-22。
- 提审材料模板化：
  - 变更内容：在 `APP_STORE_PRECHECK.md` 新增可直接复用的 Review Notes（中/英/日）和 App Privacy 填写口径，并新增上架前最后核对项（隐私链接一致性、Manifest 入库、模板复用）。
  - 原因：降低提审临场改文案风险，确保 App 内声明、网页政策、App Store Connect 信息一致。
  - 影响范围：`ios开发/tsugie/tsugie/APP_STORE_PRECHECK.md`。
  - 执行时间：2026-02-22。
- 安全/提审门禁现状记录（阻断）：
  - 变更内容：按“单模拟器、禁并行 clone”规范执行 `xcodebuild test` 复检，`HomeMapViewModelTests` 仍复现 `malloc: pointer being freed was not allocated` 导致测试进程重启；同时发现 `testFavoriteCountsReflectCheckedInStatus` 与 `upcoming` 打卡门禁规则不一致并已修正测试数据。
  - 原因：在提审前确认质量门禁真实状态，避免带阻断直接提审。
  - 影响范围：`ios开发/tsugie/tsugieTests/Presentation/HomeMap/HomeMapViewModelTests.swift`、测试日志 `/tmp/tsugie_test_20260222_2.log`、`/tmp/tsugie_test_homemap.log`。
  - 执行时间：2026-02-22。
- 提审高风险清单补齐（代码 + 清单）：
  - 变更内容：基于提审高风险条目补充 `APP_STORE_PRECHECK.md`，新增隐藏/休眠功能、后台配置一致性（IAP/订阅）、评分操纵、账号与运营合规等硬门禁；同时收敛外链风险，详情来源链接仅允许 `http/https`，隐私政策链接强制 `https` 回退。
  - 原因：将“口头注意事项”转为可执行自检项，减少提审时被判定为隐藏能力、外链风险或配置不一致的概率。
  - 影响范围：`ios开发/tsugie/tsugie/APP_STORE_PRECHECK.md`、`ios开发/tsugie/tsugie/Presentation/HomeMap/Components/DetailPanelView.swift`、`ios开发/tsugie/tsugie/App/Localization/L10n.swift`。
  - 执行时间：2026-02-22。
- 提审合规收敛（日志与外链边界）：
  - 变更内容：`HomeMapViewModel` 与 `EncodedHePlaceRepository` 的调试日志改为仅 `DEBUG` 编译生效，避免 release 输出坐标与资源路径细节；首次隐私确认三语文案与 `APP_STORE_PRECHECK.md` 三语 Review Notes 统一补充“导航或活动来源链接跳转”边界；并将 `PrivacyInfo.xcprivacy` 与三语 `InfoPlist.strings` 正式纳入版本控制。
  - 原因：收敛“生产日志暴露 + 合规声明边界不一致 + 合规关键文件未入库”三类提审风险。
  - 影响范围：`ios开发/tsugie/tsugie/Presentation/HomeMap/HomeMapViewModel.swift`、`ios开发/tsugie/tsugie/Infrastructure/EncodedHePlaceRepository.swift`、`ios开发/tsugie/tsugie/Localization/zh-Hans.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/Localization/en.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/Localization/ja.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/APP_STORE_PRECHECK.md`、`ios开发/tsugie/tsugie/PrivacyInfo.xcprivacy`、`ios开发/tsugie/tsugie/Localization/*/InfoPlist.strings`。
  - 执行时间：2026-02-22。
- 买断支付口径与提审话术补充（三语）：
  - 变更内容：首次隐私确认三语文案补充“App Store 付费下载（买断）+ 支付/兑换码/退款由 Apple 官方规则处理”；`APP_STORE_PRECHECK.md` 三语 Review Notes 同步新增对应条款并修正编号，避免提审备注与隐私页口径不一致。
  - 原因：收敛“支付责任边界不清、退款归属不明、话术不一致”导致的提审沟通风险。
  - 影响范围：`ios开发/tsugie/tsugie/Localization/zh-Hans.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/Localization/en.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/Localization/ja.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/APP_STORE_PRECHECK.md`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-22。
- iOS 英日文案文件错位修复（en/ja 对调）：
  - 变更内容：修复 `en.lproj` 与 `ja.lproj` 的 `Localizable.strings`/`InfoPlist.strings` 目录落位错误，恢复“英文文件=英文文案、日文文件=日文文案”；并重新校正首次隐私确认文案中的买断支付口径三语一致性。
  - 原因：避免因语言资源错位导致 App 语言显示反转、审核截图/功能体验与元数据语言不一致。
  - 影响范围：`ios开发/tsugie/tsugie/Localization/en.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/Localization/ja.lproj/Localizable.strings`、`ios开发/tsugie/tsugie/Localization/en.lproj/InfoPlist.strings`、`ios开发/tsugie/tsugie/Localization/ja.lproj/InfoPlist.strings`、`记录/项目变更记录.md`。
  - 执行时间：2026-02-22。
