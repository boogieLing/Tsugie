# 数据端坐标重叠质量门禁流程（v1）

## 1. 目标

- 将“脏坐标修复”从一次性修补升级为固定研发流程。
- 保证每次抓取融合后，坐标质量都经过自动修复与导出前门禁检查。

## 2. 适用范围

- `数据端/HANABI/`
- `数据端/OMATSURI/`
- iOS 资源包导出链路 `数据端/scripts/update_ios_payload.sh`

## 3. 标准流程（强制）

1. 运行抓取 + 融合（HANABI / OMATSURI）。
2. 融合阶段自动执行重叠坐标二次联网修复：
   - 识别同坐标重叠组（经纬度 6 位聚类）。
   - 仅处理低置信度来源组（`network_geocode*` / `pref_center_fallback` / `missing`）。
   - 按 `prefecture/city/venue_name/venue_address/event_name` 组合查询重查。
   - 仅在新旧坐标不同才覆盖写回。
3. 导出 iOS 数据包前执行质量门禁：
   - `bash 数据端/scripts/update_ios_payload.sh --pretty`
   - 脚本会先调用 `geo_overlap_quality_gate.py`。
4. 门禁通过后才允许导出 `he_places.index.json` / `he_places.payload.bin`。

## 4. 日志与报告

- 融合 run 日志：
  - `data/logs/<run_id>/geocode_log.csv`
  - `data/logs/<run_id>/geo_overlap_repair_log.csv`
- 导出前门禁报告：
  - `数据端/reports/latest_geo_overlap_quality_gate.json`

## 5. 失败处理

- 若门禁失败（高风险重叠组超阈值）：
  - 阻断 iOS 数据包导出。
  - 优先查看 `geo_overlap_repair_log.csv` 和 `latest_geo_overlap_quality_gate.json` 的高风险组样本。
  - 排查 query 质量、来源站点字段完整性、别名映射是否缺失。

## 6. 临时绕过（仅应急）

- 可临时跳过门禁：
  - `bash 数据端/scripts/update_ios_payload.sh --skip-geo-overlap-gate`
- 绕过后必须在变更记录中注明原因与风险，不可作为常态流程。
